<<<<<<< HEAD
def version = "1.0.${env.BUILD_NUMBER}"

// Uses registry.access.redhat.com/openshift3/jenkins-agent-maven-35-rhel7:v3.11
podTemplate(cloud: 'openshift', label: 'maven') {
  node('maven') {
    checkout scm
    stage('Build and Deploy') {
      sh "mvn -B -U versions:set -DnewVersion=${version}"
      sh "mvn clean -B -e -U install -P openshift"
    }
    stage('Rollout'){
      sh "mvn -B fabric8:apply -P openshift"
    }
  }
}

podTemplate(cloud: 'openshift', label: 'python') {
  node('python') {
    container('python') {
    checkout scm
      stage('End to End tests'){
        sh "python -m pip install --user --no-cache-dir -r requirements.txt"
        sh "./src/test/scripts/bash/all_tests.sh teknichrono-teknichrono.193b.starter-ca-central-1.openshiftapps.com"
=======
timeout(60) {

  String STAGING_HOST = "teknichrono-teknichrono-staging.router.default.svc.cluster.local"

  podTemplate(label:'teknichrono' , cloud: 'openshift') {
    node('teknichrono') {
      try {

        checkout scm
      
        container('maven') {
          stage('Version') {
            def version = "1.1." + (env.BRANCH_NAME.equals("master") ? '' : "0-${env.BRANCH_NAME}.") + env.BUILD_NUMBER
            currentBuild.description = version
            sh "mvn -B -U versions:set -DnewVersion=${version}"
          }

          stage('Build') {
            sh "mvn -B -U clean install -Popenshift"
          }

          stage('Start staging'){
            sh "mvn -B fabric8:undeploy -Popenshift -Dfabric8.namespace=teknichrono-staging"
            sh "mvn -B fabric8:apply -Popenshift -Dfabric8.namespace=teknichrono-staging"
            sh "while ! curl -fs http://${STAGING_HOST} > /dev/null; do echo 'Not started yet ...'; sleep 5; done"
          }
        }

        container('jnlp') {
          stage('CodeCov') {
            withCredentials([string(credentialsId: 'CODECOV_TOKEN', variable: 'CODECOV_TOKEN')]) {
              sh "curl -s https://codecov.io/bash > codecov.sh"
              sh "bash codecov.sh"
            }
          }
        }

        container('python') {
          stage('End to End tests'){
            sh "python -m pip install --user --no-cache-dir -r requirements.txt"
            sh "./src/test/scripts/bash/all_tests.sh ${STAGING_HOST}"
          }
        }
        
        container('maven') {
          
          stage('Promote to Production'){
            parallel Cleanup: {
              sh "mvn -B fabric8:undeploy -Popenshift -Dfabric8.namespace=teknichrono-staging"
            },
            Deploy: {
              if(env.BRANCH_NAME.equals("master")){
                echo "Deploying to production"
              }
              sh "mvn -B fabric8:apply -Popenshift -Dfabric8.namespace=teknichrono"
            }
          }
        }
      }
      catch (e) {
          echo 'Pipeline failed : ' + e
          sleep 10
          throw e
>>>>>>> b19577c... Codecov with git
      }
    }
  }
}